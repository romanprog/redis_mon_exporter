build:
  box: google/golang
  steps:
    - internal/docker-build:
        dockerfile: Dockerfile
        image-name: redis-exporter-img
    - internal/docker-push:
        image-name: redis-exporter-img
        username: _json_key
        password: $JSON_KEY
        repository: $GCR_LOCATION/redis-exporter
        tag: $WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT

deploy:
  box: google/cloud-sdk:latest
  steps:
    - script:
        name: cert
        code: echo $JSON_KEY > /tmp/json_key
    - bigtruedata/gcloud-auth-application-default:
        key: "/tmp/json_key"
    - bash-template
    - kubectl:
        command: apply -f k8s-*.yaml
        server: https://$K8_IP
